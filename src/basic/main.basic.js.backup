import {
  DISCOUNT_RATES,
  THRESHOLDS,
  POINT_BONUSES,
  TIMERS,
  DAYS,
  PRODUCT_PRICES,
  INITIAL_STOCK,
  UI_CONSTANTS,
  BONUS_RULES,
} from './constant';
import { Header, updateHeader } from './components/Header.js';
import { HelpModal } from './components/HelpModal.js';
// ==========================================
// ğŸ¯ ë§¤ì§ ë„˜ë²„ë¥¼ ì˜ë¯¸ìˆëŠ” ìƒìˆ˜ë¡œ ì¶”ì¶œ
// ==========================================

// ğŸ“Š ê¸°ë³¸ê°’ ìƒìˆ˜ë“¤
const DEFAULT_QUANTITY = 0;
const DEFAULT_POINTS = 0;
const DEFAULT_AMOUNT = 0;
const DEFAULT_COUNT = 0;

// ğŸ¨ UI ê´€ë ¨ ìƒìˆ˜ë“¤
const UI_SPACING = {
  MARGIN_BOTTOM_8: 'mb-8',
  MARGIN_BOTTOM_6: 'mb-6',
  MARGIN_BOTTOM_3: 'mb-3',
  MARGIN_TOP_3: 'mt-3',
  MARGIN_TOP_4: 'mt-4',
  MARGIN_TOP_6: 'mt-6',
  PADDING_8: 'p-8',
  PADDING_3: 'p-3',
  PADDING_4: 'p-4',
  PADDING_5: 'p-5',
  PADDING_6: 'p-6',
};

const UI_SIZES = {
  WIDTH_FULL: 'w-full',
  WIDTH_20: 'w-20',
  WIDTH_5: 'w-5',
  WIDTH_6: 'w-6',
  HEIGHT_20: 'h-20',
  HEIGHT_5: 'h-5',
  HEIGHT_6: 'h-6',
  GAP_2: 'gap-2',
  GAP_4: 'gap-4',
  GAP_5: 'gap-5',
  GAP_6: 'gap-6',
};

const UI_COLORS = {
  BLACK: 'bg-black',
  WHITE: 'bg-white',
  GRAY_200: 'border-gray-200',
  GRAY_300: 'border-gray-300',
  GRAY_400: 'text-gray-400',
  GRAY_500: 'text-gray-500',
  GRAY_600: 'text-gray-600',
  GRAY_800: 'hover:bg-gray-800',
  GRAY_900: 'hover:bg-gray-900',
  RED_500: 'text-red-500',
  BLUE_400: 'text-blue-400',
  GREEN_400: 'text-green-400',
  PURPLE_400: 'text-purple-400',
  PURPLE_600: 'text-purple-600',
  WHITE_10: 'bg-white/10',
  WHITE_60: 'text-white/60',
  BLACK_30: 'hover:shadow-black/30',
};

const UI_TEXT_SIZES = {
  XS: 'text-xs',
  SM: 'text-sm',
  BASE: 'text-base',
  LG: 'text-lg',
  XL: 'text-xl',
  X2L: 'text-2xl',
  X5L: 'text-5xl',
  X2XS: 'text-2xs',
};

const UI_FONTS = {
  NORMAL: 'font-normal',
  MEDIUM: 'font-medium',
  BOLD: 'font-bold',
  SEMIBOLD: 'font-semibold',
};

const UI_LAYOUT = {
  GRID_1_COL: 'grid-cols-1',
  GRID_2_COL: 'lg:grid-cols-[1fr_360px]',
  FLEX_COL: 'flex flex-col',
  FLEX_1: 'flex-1',
  OVERFLOW_HIDDEN: 'overflow-hidden',
  OVERFLOW_Y_AUTO: 'overflow-y-auto',
  FIXED: 'fixed',
  ABSOLUTE: 'absolute',
  RELATIVE: 'relative',
  Z_40: 'z-40',
  Z_50: 'z-50',
};

// ğŸ¯ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ìƒìˆ˜ë“¤
const BUSINESS_RULES = {
  MIN_QUANTITY: 1,
  MAX_QUANTITY_CHANGE: 1,
  POINTS_PER_WON: 1000, // 1000ì›ë‹¹ 1í¬ì¸íŠ¸
  DEFAULT_QUANTITY_INCREMENT: 1,
  DEFAULT_QUANTITY_DECREMENT: -1,
};

const DOM_SELECTORS = {
  QUANTITY_NUMBER: '.quantity-number',
  QUANTITY_CHANGE: '.quantity-change',
  REMOVE_ITEM: '.remove-item',
  TEXT_LG: '.text-lg',
  TEXT_XS: '.text-xs',
  H3: 'h3',
};

// ==========================================
// ğŸ§  ë³µì¡í•œ ì¡°ê±´ë¬¸ì„ ì˜ë¯¸ìˆëŠ” í•¨ìˆ˜ë¡œ ë¶„ë¦¬
// ==========================================

/**
 * ğŸ“¦ ìƒí’ˆ í’ˆì ˆ ì—¬ë¶€ í™•ì¸
 *
 * @param {Object} product - ìƒí’ˆ ì •ë³´
 * @returns {boolean} í’ˆì ˆ ì—¬ë¶€
 */
const isProductOutOfStock = product => {
  return product.stock === 0;
};

/**
 * ğŸ›’ ì¥ë°”êµ¬ë‹ˆ ë¹„ì–´ìˆìŒ ì—¬ë¶€ í™•ì¸
 *
 * @param {Array} cartItems - ì¥ë°”êµ¬ë‹ˆ ì•„ì´í…œ ë°°ì—´
 * @returns {boolean} ì¥ë°”êµ¬ë‹ˆ ë¹„ì–´ìˆìŒ ì—¬ë¶€
 */
const isCartEmpty = cartItems => {
  return cartItems.every(item => item.quantity === 0);
};

/**
 * âœ… ìœ íš¨í•œ ìˆ˜ëŸ‰ ì—¬ë¶€ í™•ì¸
 *
 * @param {number} quantity - ìˆ˜ëŸ‰
 * @returns {boolean} ìœ íš¨í•œ ìˆ˜ëŸ‰ ì—¬ë¶€
 */
const isValidQuantity = quantity => {
  return quantity >= 0 && quantity <= THRESHOLDS.MAX_QUANTITY;
};

/**
 * ğŸ“ˆ ìˆ˜ëŸ‰ ì¦ê°€ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
 *
 * @param {number} newQuantity - ìƒˆë¡œìš´ ìˆ˜ëŸ‰
 * @param {Object} product - ìƒí’ˆ ì •ë³´
 * @param {number} currentQuantity - í˜„ì¬ ìˆ˜ëŸ‰
 * @returns {boolean} ìˆ˜ëŸ‰ ì¦ê°€ ê°€ëŠ¥ ì—¬ë¶€
 */
const canIncreaseQuantity = (newQuantity, product, currentQuantity) => {
  return newQuantity <= product.stock + currentQuantity;
};

/**
 * ğŸ—‘ï¸ ì¥ë°”êµ¬ë‹ˆì—ì„œ ì œê±°í•´ì•¼ í•˜ëŠ”ì§€ í™•ì¸
 *
 * @param {number} quantity - ìˆ˜ëŸ‰
 * @returns {boolean} ì œê±° ì—¬ë¶€
 */
const shouldRemoveFromCart = quantity => {
  return quantity === 0;
};

/**
 * ğŸ í¬ì¸íŠ¸ í‘œì‹œ ì—¬ë¶€ í™•ì¸
 *
 * @param {number} points - í¬ì¸íŠ¸
 * @returns {boolean} í‘œì‹œ ì—¬ë¶€
 */
const shouldShowPoints = points => {
  return points > 0;
};

/**
 * ğŸ’° í• ì¸ ì •ë³´ í‘œì‹œ ì—¬ë¶€ í™•ì¸
 *
 * @param {number} discountRate - í• ì¸ìœ¨
 * @param {number} finalAmount - ìµœì¢… ê¸ˆì•¡
 * @returns {boolean} í‘œì‹œ ì—¬ë¶€
 */
const shouldShowDiscountInfo = (discountRate, finalAmount) => {
  return discountRate > 0 && finalAmount > 0;
};

/**
 * ğŸ”„ ìœ íš¨í•œ ìˆ˜ëŸ‰ ë³€ê²½ ì—¬ë¶€ í™•ì¸
 *
 * @param {number} newQty - ìƒˆë¡œìš´ ìˆ˜ëŸ‰
 * @param {Object} product - ìƒí’ˆ ì •ë³´
 * @param {number} currentQty - í˜„ì¬ ìˆ˜ëŸ‰
 * @returns {boolean} ìœ íš¨í•œ ë³€ê²½ ì—¬ë¶€
 */
const isValidQuantityChange = (newQty, product, currentQty) => {
  return (
    isValidQuantity(newQty) && canIncreaseQuantity(newQty, product, currentQty)
  );
};

/**
 * ğŸ¯ í• ì¸ ìƒíƒœì— ë”°ë¥¸ ìƒ‰ìƒ ê²°ì •
 * @param {Object} product - ìƒí’ˆ ê°ì²´
 * @returns {string} CSS ìƒ‰ìƒ í´ë˜ìŠ¤
 */
const getDiscountColor = product => {
  if (product.onSale && product.suggestSale) {
    return 'text-purple-600';
  }
  if (product.onSale) {
    return 'text-red-500';
  }
  if (product.suggestSale) {
    return 'text-blue-400';
  }
  return null;
};

/**
 * ğŸ¯ í• ì¸ ìƒíƒœ ì²´í¬ í•¨ìˆ˜ë“¤
 * @param {Object} product - ìƒí’ˆ ê°ì²´
 * @returns {boolean} í•´ë‹¹ í• ì¸ ìƒíƒœë©´ true
 */
const hasBothDiscounts = product => product.onSale && product.suggestSale;
const hasOnSaleOnly = product => product.onSale && !product.suggestSale;
const hasSuggestSaleOnly = product => !product.onSale && product.suggestSale;

/**
 * ğŸ”¥ í™”ìš”ì¼ í• ì¸ ì ìš© ì—¬ë¶€ í™•ì¸
 *
 * @param {boolean} isTuesday - í™”ìš”ì¼ ì—¬ë¶€
 * @param {number} finalAmount - ìµœì¢… ê¸ˆì•¡
 * @returns {boolean} í™”ìš”ì¼ í• ì¸ ì ìš© ì—¬ë¶€
 */
const shouldApplyTuesdayDiscount = (isTuesday, finalAmount) => {
  return isTuesday && finalAmount > 0;
};

/**
 * ğŸ í™”ìš”ì¼ ë³´ë„ˆìŠ¤ ì ìš© ì—¬ë¶€ í™•ì¸
 *
 * @param {boolean} isTuesday - í™”ìš”ì¼ ì—¬ë¶€
 * @param {number} finalAmount - ìµœì¢… ê¸ˆì•¡
 * @returns {boolean} í™”ìš”ì¼ ë³´ë„ˆìŠ¤ ì ìš© ì—¬ë¶€
 */
const shouldApplyTuesdayBonus = (isTuesday, finalAmount) => {
  return isTuesday && finalAmount > 0;
};

/**
 * âš¡ ë²ˆê°œì„¸ì¼ í• ì¸ ì ìš© ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
 *
 * @param {number} finalAmount - ìµœì¢… ê¸ˆì•¡
 * @returns {boolean} ë²ˆê°œì„¸ì¼ ì ìš© ê°€ëŠ¥ ì—¬ë¶€
 */
const canApplyLightningDiscount = finalAmount => {
  return finalAmount > 0;
};

/**
 * âŒ¨ï¸ í‚¤ë³´ë“œ+ë§ˆìš°ìŠ¤ ì„¸íŠ¸ ë³´ìœ  ì—¬ë¶€ í™•ì¸
 *
 * @param {boolean} hasKeyboard - í‚¤ë³´ë“œ ë³´ìœ  ì—¬ë¶€
 * @param {boolean} hasMouse - ë§ˆìš°ìŠ¤ ë³´ìœ  ì—¬ë¶€
 * @returns {boolean} í‚¤ë³´ë“œ+ë§ˆìš°ìŠ¤ ì„¸íŠ¸ ì—¬ë¶€
 */
const hasKeyboardMouseSet = (hasKeyboard, hasMouse) => {
  return hasKeyboard && hasMouse;
};

/**
 * ğŸ¯ í’€ì„¸íŠ¸ ë³´ìœ  ì—¬ë¶€ í™•ì¸
 *
 * @param {boolean} hasKeyboard - í‚¤ë³´ë“œ ë³´ìœ  ì—¬ë¶€
 * @param {boolean} hasMouse - ë§ˆìš°ìŠ¤ ë³´ìœ  ì—¬ë¶€
 * @param {boolean} hasMonitorArm - ëª¨ë‹ˆí„°ì•” ë³´ìœ  ì—¬ë¶€
 * @returns {boolean} í’€ì„¸íŠ¸ ì—¬ë¶€
 */
const hasFullProductSet = (hasKeyboard, hasMouse, hasMonitorArm) => {
  return hasKeyboard && hasMouse && hasMonitorArm;
};

// ==========================================
// ğŸš€ Phase 2: ì „ì—­ë³€ìˆ˜ â†’ ìƒíƒœ ê´€ë¦¬ íŒ¨í„´ (React ì¤€ë¹„)
// ==========================================

/**
 * ì• í”Œë¦¬ì¼€ì´ì…˜ ìƒíƒœ (React useState íŒ¨í„´ ì¤€ë¹„)
 * @typedef {Object} AppState
 * @property {Array} products - ìƒí’ˆ ëª©ë¡
 * @property {Object} cart - ì¥ë°”êµ¬ë‹ˆ ìƒíƒœ
 * @property {string|null} lastSelected - ë§ˆì§€ë§‰ ì„ íƒ ìƒí’ˆ ID
 */
const appState = {
  products: [], // prodList ëŒ€ì²´
  cart: {
    totalAmount: 0, // totalAmt ëŒ€ì²´
    itemCount: 0, // itemCnt ëŒ€ì²´
    bonusPoints: 0, // bonusPts ëŒ€ì²´
  },
  lastSelected: null, // lastSel ëŒ€ì²´
};

/**
 * UI ìš”ì†Œ ë ˆí¼ëŸ°ìŠ¤ (React useRef íŒ¨í„´ ì¤€ë¹„)
 * @typedef {Object} UIElements
 * @property {HTMLElement|null} stockInfo - ì¬ê³  ì •ë³´ í‘œì‹œ ìš”ì†Œ
 * @property {HTMLSelectElement|null} productSelect - ìƒí’ˆ ì„ íƒ ë“œë¡­ë‹¤ìš´
 * @property {HTMLButtonElement|null} addButton - ì¥ë°”êµ¬ë‹ˆ ì¶”ê°€ ë²„íŠ¼
 * @property {HTMLElement|null} cartDisplay - ì¥ë°”êµ¬ë‹ˆ í‘œì‹œ ì˜ì—­
 * @property {HTMLElement|null} orderSummary - ì£¼ë¬¸ ìš”ì•½ ì˜ì—­
 */
const uiElements = {
  stockInfo: null, // stockInfo ëŒ€ì²´
  productSelect: null, // sel ëŒ€ì²´
  addButton: null, // addBtn ëŒ€ì²´
  cartDisplay: null, // cartDisp ëŒ€ì²´
  orderSummary: null, // sum ëŒ€ì²´ (ìƒˆë¡œ ì¶”ê°€)
};

// ğŸ·ï¸ ìƒí’ˆ ID ìƒìˆ˜
const PRODUCT_ONE = 'p1';
const PRODUCT_TWO = 'p2';
const PRODUCT_THREE = 'p3';
const PRODUCT_FOUR = 'p4';
const PRODUCT_FIVE = 'p5';

// ==========================================
// ğŸš€ Phase 4: ì¤‘ë³µì½”ë“œ ì œê±° (DRY ì›ì¹™ ì ìš©)
// ==========================================

/**
 * ğŸ¤– [AI-REFACTORED] IDë¡œ ìƒí’ˆ ì°¾ê¸° (ì¤‘ë³µ ì œê±° ìœ í‹¸ë¦¬í‹°)
 *
 * @description ìƒí’ˆ IDë¥¼ í†µí•´ ìƒí’ˆ ê°ì²´ë¥¼ ì¡°íšŒí•˜ëŠ” ê³µí†µ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
 *
 * ğŸ¯ DRY ì›ì¹™ ì ìš©:
 * - 8ê³³ì—ì„œ ë°˜ë³µë˜ë˜ for-loop + id ì²´í¬ ë¡œì§ì„ í•˜ë‚˜ë¡œ í†µí•©
 * - ì„±ëŠ¥ ê°œì„ : find() ë©”ì„œë“œë¡œ ì¡°ê¸° ì¢…ë£Œ
 * - ê°€ë…ì„± í–¥ìƒ: ì˜ë„ê°€ ëª…í™•í•œ í•¨ìˆ˜ëª…
 *
 * @param {string} productId - ì°¾ì„ ìƒí’ˆì˜ ID
 * @returns {Object|null} ì°¾ì€ ìƒí’ˆ ê°ì²´ ë˜ëŠ” null
 */
const findProductById = productId => {
  return appState.products.find(product => product.id === productId) || null;
};

/**
 * ğŸ¤– [AI-REFACTORED] ì¥ë°”êµ¬ë‹ˆ ì•„ì´í…œì˜ ìˆ˜ëŸ‰ ì¡°íšŒ (ì¤‘ë³µ ì œê±° ìœ í‹¸ë¦¬í‹°)
 *
 * @description DOM ìš”ì†Œì—ì„œ ìˆ˜ëŸ‰ ì •ë³´ë¥¼ ì¶”ì¶œí•˜ëŠ” ê³µí†µ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
 *
 * ğŸ¯ DRY ì›ì¹™ ì ìš©:
 * - 5ê³³ì—ì„œ ë°˜ë³µë˜ë˜ querySelector + parseInt ë¡œì§ í†µí•©
 * - ì—ëŸ¬ ì²˜ë¦¬ ì¶”ê°€: ìš”ì†Œê°€ ì—†ëŠ” ê²½ìš° ê¸°ë³¸ê°’ ë°˜í™˜
 *
 * @param {HTMLElement} cartItemElement - ì¥ë°”êµ¬ë‹ˆ ì•„ì´í…œ DOM ìš”ì†Œ
 * @returns {number} ìˆ˜ëŸ‰ (ê¸°ë³¸ê°’: 0)
 */
const getCartItemQuantity = cartItemElement => {
  const qtyElem = cartItemElement.querySelector(DOM_SELECTORS.QUANTITY_NUMBER);
  return qtyElem ? parseInt(qtyElem.textContent) : DEFAULT_QUANTITY;
};

/**
 * ğŸ¤– [AI-REFACTORED] í• ì¸ ìƒíƒœì— ë”°ë¥¸ ìƒí’ˆëª… í…ìŠ¤íŠ¸ ìƒì„± (ì¤‘ë³µ ì œê±° ìœ í‹¸ë¦¬í‹°)
 *
 * @description ìƒí’ˆì˜ í• ì¸ ìƒíƒœì— ë”°ë¼ ì ì ˆí•œ ì•„ì´ì½˜ê³¼ í…ìŠ¤íŠ¸ë¥¼ ìƒì„±
 *
 * ğŸ¯ DRY ì›ì¹™ ì ìš©:
 * - ì—¬ëŸ¬ ê³³ì—ì„œ ë°˜ë³µë˜ë˜ í• ì¸ ì•„ì´ì½˜ ë¡œì§ í†µí•©
 * - ê°€ë…ì„± í–¥ìƒ: í• ì¸ ìƒíƒœ íŒë‹¨ ë¡œì§ ë¶„ë¦¬
 *
 * @param {Object} product - ìƒí’ˆ ê°ì²´
 * @returns {string} í• ì¸ ì•„ì´ì½˜ì´ í¬í•¨ëœ ìƒí’ˆëª…
 */
const getDiscountedProductName = product => {
  // ğŸ¯ ë°ì´í„° ê¸°ë°˜ í• ì¸ ì•„ì´ì½˜ ìƒì„± (ì¤‘ë³µ ì¡°ê±´ ê°œì„ )
  const icons = [];
  if (product.onSale) {
    icons.push('âš¡');
  }
  if (product.suggestSale) {
    icons.push('ğŸ’');
  }

  return icons.length > DEFAULT_COUNT
    ? `${icons.join('')}${product.name}`
    : product.name;
};

/**
 * ğŸ¤– [AI-REFACTORED] í• ì¸ ìƒíƒœì— ë”°ë¥¸ ê°€ê²© HTML ìƒì„± (ì¤‘ë³µ ì œê±° ìœ í‹¸ë¦¬í‹°)
 *
 * @description ìƒí’ˆì˜ í• ì¸ ìƒíƒœì— ë”°ë¼ ì ì ˆí•œ ê°€ê²© í‘œì‹œ HTMLì„ ìƒì„±
 *
 * ğŸ¯ DRY ì›ì¹™ ì ìš©:
 * - ì—¬ëŸ¬ ê³³ì—ì„œ ë°˜ë³µë˜ë˜ ê°€ê²© í‘œì‹œ ë¡œì§ í†µí•©
 * - CSS í´ë˜ìŠ¤ì™€ ìƒ‰ìƒ ê´€ë¦¬ ì¤‘ì•™í™”
 *
 * @param {Object} product - ìƒí’ˆ ê°ì²´
 * @returns {string} í• ì¸ ê°€ê²©ì´ í‘œì‹œëœ HTML
 */
const getDiscountedPriceHTML = product => {
  // ğŸ§  ë³µì¡í•œ ì¡°ê±´ â†’ ì˜ë¯¸ìˆëŠ” í•¨ìˆ˜ë¡œ ê°œì„ 
  const discountRate =
    product.originalVal > product.val
      ? (product.originalVal - product.val) / product.originalVal
      : 0;
  const discountColor = getDiscountColor(discountRate);
  if (discountColor) {
    return `<span class="line-through text-gray-400">â‚©${product.originalVal.toLocaleString()}</span> <span class="${discountColor}">â‚©${product.val.toLocaleString()}</span>`;
  }

  return `â‚©${product.val.toLocaleString()}`;
};

// ==========================================
// ğŸ§  ë³µì¡í•œ ì¡°ê±´ë¬¸ì„ ì˜ë¯¸ìˆëŠ” í•¨ìˆ˜ë¡œ ë¶„ë¦¬
// ==========================================

/**
 * ğŸ¤– [AI-REFACTORED] ìœ íš¨í•œ ìˆ˜ëŸ‰ ë³€ê²½ì¸ì§€ í™•ì¸
 * @param {number} newQty - ìƒˆë¡œìš´ ìˆ˜ëŸ‰
 * @param {Object} product - ìƒí’ˆ ê°ì²´
 * @param {number} currentQty - í˜„ì¬ ìˆ˜ëŸ‰
 * @returns {boolean} ìœ íš¨í•œ ìˆ˜ëŸ‰ ë³€ê²½ì´ë©´ true
 */

// ==========================================
// ğŸš€ ë‹¨ìˆœí•œ DOM ìš”ì†Œ ìºì‹œ (ì¤‘ë³µ ì œê±°ìš©)
// ==========================================

/**
 * ğŸ¤– [AI-REFACTORED] ìì£¼ ì‚¬ìš©ë˜ëŠ” DOM ìš”ì†Œë“¤ ìºì‹œ
 *
 * ğŸ¯ ëª©ì : ë™ì¼í•œ getElementById í˜¸ì¶œ ì¤‘ë³µ ì œê±°
 * - loyaltyPoints: 3ê³³ì—ì„œ ì‚¬ìš©
 * - itemCount: 2ê³³ì—ì„œ ì‚¬ìš©
 * - ë‚˜ë¨¸ì§€: 1ê³³ì”©ì´ì§€ë§Œ í†µì¼ì„± ìœ„í•´ í¬í•¨
 */
const domElements = {
  loyaltyPoints: null,
  summaryDetails: null,
  tuesdaySpecial: null,
  discountInfo: null,
};

/**
 * ğŸ¤– [AI-REFACTORED] ì¥ë°”êµ¬ë‹ˆ ì†Œê³„ ë° ê°œë³„ í• ì¸ ê³„ì‚° (ìˆœìˆ˜ í•¨ìˆ˜)
 *
 * @description ì¥ë°”êµ¬ë‹ˆ ì•„ì´í…œë“¤ì˜ ì†Œê³„ì™€ ê°œë³„ ìƒí’ˆ í• ì¸ì„ ê³„ì‚°í•˜ëŠ” ìˆœìˆ˜ í•¨ìˆ˜
 *
 * ğŸ¯ AI ë¦¬íŒ©í† ë§ í¬ì¸íŠ¸:
 * - ì¤‘ì²© ë°˜ë³µë¬¸ ì œê±° (O(nÂ²) â†’ O(n))
 * - ìˆœìˆ˜ í•¨ìˆ˜ë¡œ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥
 * - ë‹¨ì¼ ì±…ì„: ê³„ì‚°ë§Œ ë‹´ë‹¹
 *
 * @param {HTMLCollection} cartItems - ì¥ë°”êµ¬ë‹ˆ DOM ìš”ì†Œë“¤
 * @param {Array} productList - ìƒí’ˆ ëª©ë¡
 * @returns {Object} { subTotal, itemCount, totalAmount, itemDiscounts }
 */
function calculateCartSubtotal(cartItems, productList) {
  // ==========================================
  // ğŸš€ ì„±ëŠ¥ ê°œì„ : Mapìœ¼ë¡œ O(1) ê²€ìƒ‰
  // ==========================================
  const productMap = new Map();
  for (const product of productList) {
    productMap.set(product.id, product);
  }

  // ==========================================
  // ğŸ§® ê³„ì‚° ë³€ìˆ˜ ì´ˆê¸°í™”
  // ==========================================
  let subTotal = 0;
  let itemCount = 0;
  let totalAmount = 0;
  const itemDiscounts = [];

  // ==========================================
  // ğŸ“Š ì¥ë°”êµ¬ë‹ˆ ì•„ì´í…œ ìˆœíšŒ - Array.from() + forEach()ë¡œ í˜„ëŒ€í™”
  // ==========================================
  Array.from(cartItems).forEach(cartItem => {
    // âš¡ ì„±ëŠ¥ ìµœì í™”: Mapìœ¼ë¡œ O(1) ìƒí’ˆ ê²€ìƒ‰
    const product = productMap.get(cartItem.id);

    if (!product) {
      return; // ğŸ›¡ï¸ Guard Clause: ìœ íš¨í•˜ì§€ ì•Šì€ ìƒí’ˆì€ ê±´ë„ˆë›°ê¸°
    }

    // ğŸ¯ DRY ì ìš©: ì¤‘ë³µ ì œê±°ëœ ìœ í‹¸ë¦¬í‹° ì‚¬ìš©
    const quantity = getCartItemQuantity(cartItem);
    const itemTotal = product.val * quantity;

    subTotal += itemTotal;
    itemCount += quantity;

    // ==========================================
    // ğŸ¯ ê°œë³„ ìƒí’ˆ í• ì¸ ê³„ì‚°
    // ==========================================
    let discountRate = 0;

    if (quantity >= THRESHOLDS.ITEM_DISCOUNT_MIN) {
      // ğŸ”§ í•˜ë“œì½”ë”© ì œê±°ë¥¼ ìœ„í•œ ì„ì‹œ ë°©ì•ˆ (ì¶”í›„ ê°œì„  ì˜ˆì •)
      const discountMap = {
        [PRODUCT_ONE]: DISCOUNT_RATES.KEYBOARD,
        [PRODUCT_TWO]: DISCOUNT_RATES.MOUSE,
        [PRODUCT_THREE]: DISCOUNT_RATES.MONITOR_ARM,
        [PRODUCT_FOUR]: DISCOUNT_RATES.POUCH,
        [PRODUCT_FIVE]: DISCOUNT_RATES.SPEAKER,
      };

      discountRate = discountMap[product.id] || 0;

      if (discountRate > 0) {
        itemDiscounts.push({
          name: product.name,
          discount: discountRate * 100,
        });
      }
    }

    // ğŸ’° ê°œë³„ ìƒí’ˆ í• ì¸ ì ìš© í›„ ì´ì•¡ ê³„ì‚°
    totalAmount += itemTotal * (1 - discountRate);

    // ==========================================
    // ğŸ¨ UI ìƒíƒœ ì—…ë°ì´íŠ¸ (ì„ì‹œ - ì¶”í›„ ë¶„ë¦¬ ì˜ˆì •)
    // ==========================================
    const priceElems = cartItem.querySelectorAll(
      `${DOM_SELECTORS.TEXT_LG}, ${DOM_SELECTORS.TEXT_XS}`,
    );
    priceElems.forEach(elem => {
      if (elem.classList.contains('text-lg')) {
        elem.style.fontWeight =
          quantity >= THRESHOLDS.ITEM_DISCOUNT_MIN ? 'bold' : 'normal';
      }
    });
  });

  return {
    subTotal,
    itemCount,
    totalAmount,
    itemDiscounts,
  };
}

/**
 * ğŸ¤– [AI-REFACTORED] í• ì¸ ê³„ì‚° (ìˆœìˆ˜ í•¨ìˆ˜)
 *
 * @description ëŒ€ëŸ‰êµ¬ë§¤ í• ì¸ê³¼ í™”ìš”ì¼ í• ì¸ì„ ê³„ì‚°í•˜ëŠ” ìˆœìˆ˜ í•¨ìˆ˜
 *
 * ğŸ¯ SRP ì ìš©:
 * - ë‹¨ì¼ ì±…ì„: í• ì¸ ê³„ì‚°ë§Œ ë‹´ë‹¹
 * - ìˆœìˆ˜ í•¨ìˆ˜: ë¶€ì‘ìš© ì—†ìŒ
 * - í…ŒìŠ¤íŠ¸ ê°€ëŠ¥: ì…ë ¥/ì¶œë ¥ ëª…í™•
 *
 * @param {number} subTotal - ì†Œê³„ ê¸ˆì•¡
 * @param {number} itemCount - ì´ ì•„ì´í…œ ìˆ˜ëŸ‰
 * @param {number} totalAmountAfterItemDiscount - ê°œë³„ í• ì¸ ì ìš© í›„ ê¸ˆì•¡
 * @returns {Object} { finalAmount, discountRate, isTuesdayApplied }
 */
function calculateFinalDiscounts(
  subTotal,
  itemCount,
  totalAmountAfterItemDiscount,
) {
  let finalAmount = totalAmountAfterItemDiscount;
  let discountRate = 0;

  // ğŸ¯ ëŒ€ëŸ‰êµ¬ë§¤ í• ì¸ ì ìš© (30ê°œ ì´ìƒì‹œ 25% í• ì¸)
  if (itemCount >= THRESHOLDS.BULK_DISCOUNT_MIN) {
    finalAmount = subTotal * (1 - DISCOUNT_RATES.BULK_DISCOUNT);
    discountRate = DISCOUNT_RATES.BULK_DISCOUNT;
  } else {
    // ğŸ§® ê°œë³„ í• ì¸ë§Œ ì ìš©ëœ ê²½ìš°ì˜ ì „ì²´ í• ì¸ìœ¨ ê³„ì‚°
    if (subTotal > 0) {
      discountRate = (subTotal - totalAmountAfterItemDiscount) / subTotal;
    }
  }

  // ğŸ¯ í™”ìš”ì¼ ì¶”ê°€ í• ì¸ ì ìš©
  const today = new Date();
  const isTuesday = today.getDay() === DAYS.TUESDAY;
  let isTuesdayApplied = false;

  // ğŸ§  ë³µì¡í•œ ì¡°ê±´ â†’ ì˜ë¯¸ìˆëŠ” í•¨ìˆ˜ë¡œ ê°œì„ 
  if (shouldApplyTuesdayDiscount(isTuesday, finalAmount)) {
    finalAmount = finalAmount * (1 - DISCOUNT_RATES.TUESDAY_DISCOUNT);
    discountRate = 1 - finalAmount / subTotal;
    isTuesdayApplied = true;
  }

  return {
    finalAmount: Math.round(finalAmount),
    discountRate,
    isTuesdayApplied,
  };
}

/**
 * ğŸ¤– [AI-REFACTORED] ì• í”Œë¦¬ì¼€ì´ì…˜ ìƒíƒœ ì´ˆê¸°í™”
 *
 * @description ì•± ì‹œì‘ì‹œ í•„ìš”í•œ ìƒíƒœ ë°ì´í„°ë¥¼ ì„¤ì •
 * - ì¥ë°”êµ¬ë‹ˆ ìƒíƒœ ì´ˆê¸°í™” (ì´ì•¡, ìˆ˜ëŸ‰, í¬ì¸íŠ¸)
 * - ìƒí’ˆ ëª©ë¡ ë°ì´í„° ì„¤ì •
 * - ë§ˆì§€ë§‰ ì„ íƒ ìƒí’ˆ ì´ˆê¸°í™”
 */
function initializeAppState() {
  // ğŸš€ ì• í”Œë¦¬ì¼€ì´ì…˜ ìƒíƒœ ì´ˆê¸°í™” (ì¥ë°”êµ¬ë‹ˆ, í¬ì¸íŠ¸, ì„ íƒ ìƒíƒœ)
  appState.cart.totalAmount = UI_CONSTANTS.INITIAL_CART_AMOUNT;
  appState.cart.itemCount = UI_CONSTANTS.INITIAL_CART_COUNT;
  appState.cart.bonusPoints = UI_CONSTANTS.INITIAL_BONUS_POINTS;
  appState.lastSelected = null;

  // ğŸ“¦ ìƒí’ˆ ëª©ë¡ ë°ì´í„° ì„¤ì • (ê°€ê²©, ì¬ê³ , í• ì¸ ìƒíƒœ ì´ˆê¸°í™”)
  appState.products = [
    {
      id: PRODUCT_ONE,
      name: 'ë²„ê·¸ ì—†ì• ëŠ” í‚¤ë³´ë“œ',
      val: PRODUCT_PRICES.KEYBOARD,
      originalVal: PRODUCT_PRICES.KEYBOARD,
      quantity: INITIAL_STOCK.KEYBOARD,
      onSale: false,
      suggestSale: false,
    },
    {
      id: PRODUCT_TWO,
      name: 'ìƒì‚°ì„± í­ë°œ ë§ˆìš°ìŠ¤',
      val: PRODUCT_PRICES.MOUSE,
      originalVal: PRODUCT_PRICES.MOUSE,
      quantity: INITIAL_STOCK.MOUSE,
      onSale: false,
      suggestSale: false,
    },
    {
      id: PRODUCT_THREE,
      name: 'ê±°ë¶ëª© íƒˆì¶œ ëª¨ë‹ˆí„°ì•”',
      val: PRODUCT_PRICES.MONITOR_ARM,
      originalVal: PRODUCT_PRICES.MONITOR_ARM,
      quantity: INITIAL_STOCK.MONITOR_ARM,
      onSale: false,
      suggestSale: false,
    },
    {
      id: PRODUCT_FOUR,
      name: 'ì—ëŸ¬ ë°©ì§€ ë…¸íŠ¸ë¶ íŒŒìš°ì¹˜',
      val: PRODUCT_PRICES.POUCH,
      originalVal: PRODUCT_PRICES.POUCH,
      quantity: INITIAL_STOCK.POUCH,
      onSale: false,
      suggestSale: false,
    },
    {
      id: PRODUCT_FIVE,
      name: 'ì½”ë”©í•  ë•Œ ë“£ëŠ” Lo-Fi ìŠ¤í”¼ì»¤',
      val: PRODUCT_PRICES.SPEAKER,
      originalVal: PRODUCT_PRICES.SPEAKER,
      quantity: INITIAL_STOCK.SPEAKER,
      onSale: false,
      suggestSale: false,
    },
  ];
}

/**
 * ì•± ì „ì²´ ì´ˆê¸°í™” ë° UI ìƒì„±
 *
 * @description ì‡¼í•‘ì¹´íŠ¸ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ì „ì²´ ì´ˆê¸°í™”ë¥¼ ë‹´ë‹¹
 * - ì œí’ˆ ëª©ë¡ ì´ˆê¸°í™”
 * - DOM ìš”ì†Œë“¤ ìƒì„± ë° ë°°ì¹˜
 * - ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
 * - ë²ˆê°œì„¸ì¼ ë° ì¶”ì²œ ìƒí’ˆ íƒ€ì´ë¨¸ ì„¤ì •
 *
 * @sideEffects
 * - ì „ì—­ë³€ìˆ˜ ìˆ˜ì • (prodList, totalAmt, itemCnt ë“±)
 * - DOM ì¡°ì‘ (app ìš”ì†Œì— UI ì¶”ê°€)
 * - íƒ€ì´ë¨¸ ì„¤ì • (ë²ˆê°œì„¸ì¼, ì¶”ì²œìƒí’ˆ)
 */
function main() {
  const root = document.getElementById('app');
  // const header = document.createElement('div');
  const gridContainer = document.createElement('div');
  const leftColumn = document.createElement('div');
  const selectorContainer = document.createElement('div');

  const lightningDelay = Math.random() * TIMERS.MAX_LIGHTNING_DELAY;

  const header = Header(DEFAULT_COUNT);
  // 1ï¸âƒ£ ìƒíƒœ ì´ˆê¸°í™”
  initializeAppState();

  // 2ï¸âƒ£ DOM êµ¬ì¡° ìƒì„±
  // ğŸ·ï¸ ë©”ì¸ í—¤ë” ì„¹ì…˜ ìƒì„± (í—¤ë” ì»´í¬ë„ŒíŠ¸ ì‚¬ìš©)

  // ğŸ›’ ìƒí’ˆ ì„ íƒ ì˜ì—­ ìƒì„± (ë“œë¡­ë‹¤ìš´ + ì¶”ê°€ ë²„íŠ¼)
  uiElements.productSelect = document.createElement('select');
  uiElements.productSelect.id = 'product-select';
  uiElements.productSelect.className =
    'w-full p-3 border border-gray-300 rounded-lg text-base mb-3';

  uiElements.addButton = document.createElement('button');
  uiElements.addButton.id = 'add-to-cart';
  uiElements.addButton.innerHTML = 'Add to Cart';
  uiElements.addButton.className =
    'w-full py-3 bg-black text-white text-sm font-medium uppercase tracking-wider hover:bg-gray-800 transition-all';

  uiElements.stockInfo = document.createElement('div');
  uiElements.stockInfo.id = 'stock-status';
  uiElements.stockInfo.className =
    'text-xs text-red-500 mt-3 whitespace-pre-line';

  // ğŸ¨ ë©”ì¸ ë ˆì´ì•„ì›ƒ êµ¬ì„± (ì¢Œì¸¡ ì¹´íŠ¸ + ìš°ì¸¡ ìš”ì•½)
  selectorContainer.className = 'mb-6 pb-6 border-b border-gray-200';
  selectorContainer.appendChild(uiElements.productSelect);
  selectorContainer.appendChild(uiElements.addButton);
  selectorContainer.appendChild(uiElements.stockInfo);

  leftColumn.className = 'bg-white border border-gray-200 p-8 overflow-y-auto';
  leftColumn.appendChild(selectorContainer);

  uiElements.cartDisplay = document.createElement('div');
  uiElements.cartDisplay.id = 'cart-items';
  leftColumn.appendChild(uiElements.cartDisplay);

  // ğŸ“‹ ì£¼ë¬¸ ìš”ì•½ ì˜ì—­ ìƒì„± (ì´ì•¡, í• ì¸, í¬ì¸íŠ¸ í‘œì‹œ)
  uiElements.orderSummary = document.createElement('div');
  uiElements.orderSummary.className = 'bg-black text-white p-8 flex flex-col';
  uiElements.orderSummary.innerHTML = `
    <h2 class="text-xs font-medium mb-5 tracking-extra-wide uppercase">Order Summary</h2>
    <div class="flex-1 flex flex-col">
      <div id="summary-details" class="space-y-3"></div>
      <div class="mt-auto">
        <div id="discount-info" class="mb-4"></div>
        <div id="cart-total" class="pt-5 border-t border-white/10">
          <div class="flex justify-between items-baseline">
            <span class="text-sm uppercase tracking-wider">Total</span>
            <div class="text-2xl tracking-tight">â‚©0</div>
          </div>
          <div id="loyalty-points" class="text-xs text-blue-400 mt-2 text-right">ì ë¦½ í¬ì¸íŠ¸: 0p</div>
        </div>
        <div id="tuesday-special" class="mt-4 p-3 bg-white/10 rounded-lg hidden">
          <div class="flex items-center gap-2">
            <span class="text-2xs">ğŸ‰</span>
            <span class="text-xs uppercase tracking-wide">Tuesday Special 10% Applied</span>
          </div>
        </div>
      </div>
    </div>
    <button class="w-full py-4 bg-white text-black text-sm font-normal uppercase tracking-super-wide cursor-pointer mt-6 transition-all hover:-translate-y-0.5 hover:shadow-lg hover:shadow-black/30">
      Proceed to Checkout
    </button>
    <p class="mt-4 text-2xs text-white/60 text-center leading-relaxed">
      Free shipping on all orders.<br>
      <span id="points-notice">Earn loyalty points with purchase.</span>
    </p>
  `;

  // ğŸ”² ë©”ì¸ ê·¸ë¦¬ë“œ êµ¬ì„± (2ì—´ ë ˆì´ì•„ì›ƒ: ì¹´íŠ¸ + ìš”ì•½)
  gridContainer.className =
    'grid grid-cols-1 lg:grid-cols-[1fr_360px] gap-6 flex-1 overflow-hidden';
  gridContainer.appendChild(leftColumn);
  gridContainer.appendChild(uiElements.orderSummary);

  // ğŸ’¡ ë„ì›€ë§ ëª¨ë‹¬ ì»´í¬ë„ŒíŠ¸ ìƒì„±
  const { toggle: manualToggle, overlay: manualOverlay } = HelpModal();
  root.appendChild(header);
  root.appendChild(gridContainer);
  root.appendChild(manualToggle);
  root.appendChild(manualOverlay);

  // 3ï¸âƒ£ DOM ìš”ì†Œ ìºì‹œ ì´ˆê¸°í™” (ë‹¨ìˆœí•˜ê²Œ)
  domElements.loyaltyPoints = document.getElementById('loyalty-points');
  domElements.summaryDetails = document.getElementById('summary-details');
  domElements.tuesdaySpecial = document.getElementById('tuesday-special');
  domElements.discountInfo = document.getElementById('discount-info');

  // 4ï¸âƒ£ ì´ˆê¸° ê³„ì‚° ë° UI ì—…ë°ì´íŠ¸
  updateProductSelectUI();
  handleCalculateCartStuff();

  // 4ï¸âƒ£ íƒ€ì´ë¨¸ ì„¤ì •
  setTimeout(() => {
    setInterval(() => {
      const luckyIdx = Math.floor(Math.random() * appState.products.length);
      const luckyItem = appState.products[luckyIdx];
      // ğŸ§  ë³µì¡í•œ ì¡°ê±´ â†’ ì˜ë¯¸ìˆëŠ” í•¨ìˆ˜ë¡œ ê°œì„ 
      if (canApplyLightningDiscount(luckyItem)) {
        luckyItem.val = Math.round(
          luckyItem.originalVal * (1 - DISCOUNT_RATES.LIGHTNING_SALE),
        );
        luckyItem.onSale = true;
        alert(
          `âš¡ë²ˆê°œì„¸ì¼! ${luckyItem.name}ì´(ê°€) ${DISCOUNT_RATES.LIGHTNING_SALE * 100}% í• ì¸ ì¤‘ì…ë‹ˆë‹¤!`,
        );
        updateProductSelectUI();
        updateCartPricesUI();
      }
    }, TIMERS.LIGHTNING_SALE_INTERVAL);
  }, lightningDelay);

  setTimeout(() => {
    setInterval(() => {
      if (isCartEmpty(uiElements.cartDisplay.children)) {
        return;
      }
      if (appState.lastSelected) {
        // ğŸ¯ forë¬¸ â†’ find() ë©”ì„œë“œë¡œ í˜„ëŒ€í™”
        const suggest = appState.products.find(
          product =>
            product.id !== appState.lastSelected &&
            product.quantity > 0 &&
            !product.suggestSale,
        );
        if (suggest) {
          alert(
            `ğŸ’ ${suggest.name}ì€(ëŠ”) ì–´ë– ì„¸ìš”? ì§€ê¸ˆ êµ¬ë§¤í•˜ì‹œë©´ ${DISCOUNT_RATES.SUGGEST_SALE * 100}% ì¶”ê°€ í• ì¸!`,
          );
          suggest.val = Math.round(
            suggest.val * (1 - DISCOUNT_RATES.SUGGEST_SALE),
          );
          suggest.suggestSale = true;
          updateProductSelectUI();
          updateCartPricesUI();
        }
      }
    }, TIMERS.SUGGEST_SALE_INTERVAL);
  }, Math.random() * TIMERS.MAX_INITIAL_DELAY);
}

/**
 * ìƒí’ˆ ì„ íƒ ì˜µì…˜ ì—…ë°ì´íŠ¸ (React íŒ¨í„´ ë„¤ì´ë°)
 *
 * @description ì œí’ˆ ëª©ë¡ì„ ê¸°ë°˜ìœ¼ë¡œ ì„ íƒ ë“œë¡­ë‹¤ìš´ì˜ ì˜µì…˜ë“¤ì„ ë™ì ìœ¼ë¡œ ìƒì„±/ì—…ë°ì´íŠ¸
 * - ì¬ê³  ìƒíƒœì— ë”°ë¥¸ ì˜µì…˜ í‘œì‹œ (í’ˆì ˆ, í• ì¸ ë“±)
 * - ì„¸ì¼ ë° ì¶”ì²œ ìƒí’ˆ í‘œì‹œ (âš¡, ğŸ’ ì•„ì´ì½˜)
 * - ì¬ê³  ë¶€ì¡±ì‹œ ë“œë¡­ë‹¤ìš´ í…Œë‘ë¦¬ ìƒ‰ìƒ ë³€ê²½ (ì£¼í™©ìƒ‰)
 *
 * ğŸ¯ ë„¤ì´ë° ê°œì„ : onUpdateSelectOptions â†’ updateProductSelectUI
 * - React íŒ¨í„´: update + ëŒ€ìƒ + UI
 * - ì˜ë¯¸ ëª…í™•í™”: ìƒí’ˆ ì„ íƒ UI ì—…ë°ì´íŠ¸
 *
 * @sideEffects
 * - productSelect ìš”ì†Œì˜ innerHTML ìˆ˜ì •
 * - productSelect ìš”ì†Œì˜ style.borderColor ìˆ˜ì •
 */
const updateProductSelectUI = () => {
  uiElements.productSelect.innerHTML = '';

  // ğŸ¯ forë¬¸ â†’ reduce() ë©”ì„œë“œë¡œ í˜„ëŒ€í™” (ì˜ë¯¸ì—†ëŠ” ë³€ìˆ˜ëª…ë„ ê°œì„ )
  const totalStock = appState.products.reduce(
    (stockSum, product) => stockSum + product.quantity,
    DEFAULT_COUNT,
  );
  // ğŸ¯ forë¬¸ + IIFE â†’ forEach() ë©”ì„œë“œë¡œ í˜„ëŒ€í™”
  appState.products.forEach(product => {
    const option = document.createElement('option');
    option.value = product.id;

    let discountText = '';
    if (product.onSale) {
      discountText += ' âš¡SALE';
    }
    if (product.suggestSale) {
      discountText += ' ğŸ’ì¶”ì²œ';
    }

    if (isProductOutOfStock(product)) {
      option.textContent = `${product.name} - ${product.val}ì› (í’ˆì ˆ)${discountText}`;
      option.disabled = true;
      option.className = 'text-gray-400';
    } else {
      // ğŸ§  ë³µì¡í•œ ì¡°ê±´ â†’ ì˜ë¯¸ìˆëŠ” í•¨ìˆ˜ë¡œ ê°œì„ 
      if (hasBothDiscounts(product.onSale, product.suggestSale)) {
        option.textContent = `âš¡ğŸ’${product.name} - ${product.originalVal}ì› â†’ ${
          product.val
        }ì› (25% SUPER SALE!)`;
        option.className = 'text-purple-600 font-bold';
      } else if (hasOnSaleOnly(product.onSale, product.suggestSale)) {
        option.textContent = `âš¡${product.name} - ${product.originalVal}ì› â†’ ${
          product.val
        }ì› (20% SALE!)`;
        option.className = 'text-red-500 font-bold';
      } else if (hasSuggestSaleOnly(product.onSale, product.suggestSale)) {
        option.textContent = `ğŸ’${product.name} - ${product.originalVal}ì› â†’ ${
          product.val
        }ì› (5% ì¶”ì²œí• ì¸!)`;
        option.className = 'text-blue-500 font-bold';
      } else {
        option.textContent = `${product.name} - ${product.val}ì›${discountText}`;
      }
    }

    uiElements.productSelect.appendChild(option);
  });
  if (totalStock < THRESHOLDS.STOCK_ALERT_THRESHOLD) {
    uiElements.productSelect.style.borderColor = 'orange';
  } else {
    uiElements.productSelect.style.borderColor = '';
  }
};

/**
 * ğŸ¤– [AI-REFACTORED] ì£¼ë¬¸ ìš”ì•½ UI ì—…ë°ì´íŠ¸ (SRP ì ìš©)
 *
 * @description ì¥ë°”êµ¬ë‹ˆ ì•„ì´í…œë³„ ìƒì„¸ ë‚´ì—­ì„ UIì— í‘œì‹œ
 *
 * ğŸ¯ SRP ì ìš©:
 * - ë‹¨ì¼ ì±…ì„: ì£¼ë¬¸ ìš”ì•½ UI ì—…ë°ì´íŠ¸ë§Œ ë‹´ë‹¹
 * - DOM ì¡°ì‘ë§Œ ì²˜ë¦¬
 * - ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ë°°ì œ
 *
 * @param {HTMLCollection} cartItems - ì¥ë°”êµ¬ë‹ˆ DOM ìš”ì†Œë“¤
 * @param {Array} products - ìƒí’ˆ ëª©ë¡
 * @param {number} subTotal - ì†Œê³„
 * @param {Array} itemDiscounts - ê°œë³„ ìƒí’ˆ í• ì¸ ì •ë³´
 * @param {number} itemCount - ì´ ì•„ì´í…œ ìˆ˜
 * @param {boolean} isTuesdayApplied - í™”ìš”ì¼ í• ì¸ ì ìš© ì—¬ë¶€
 */
function updateOrderSummaryUI(
  cartItems,
  products,
  subTotal,
  itemDiscounts,
  itemCount,
  isTuesdayApplied,
) {
  // ğŸ¯ ìºì‹œëœ DOM ìš”ì†Œ ì‚¬ìš© (ì¤‘ë³µ ì œê±°ë¡œ ì„±ëŠ¥ í–¥ìƒ)
  const { summaryDetails } = domElements;

  // ğŸš€ ì£¼ë¬¸ ìš”ì•½ ì´ˆê¸°í™” (ê¸°ì¡´ ë‚´ìš© ì‚­ì œ)
  summaryDetails.innerHTML = '';

  if (subTotal <= 0) {
    return;
  }

  // ğŸ¯ ì„±ëŠ¥ ê°œì„ : Mapìœ¼ë¡œ O(1) ê²€ìƒ‰
  const productMap = new Map();
  for (const product of products) {
    productMap.set(product.id, product);
  }

  // ğŸ“‹ ì•„ì´í…œë³„ ìƒì„¸ ë‚´ì—­ (Array.from() + forEach()ë¡œ í˜„ëŒ€í™”)
  Array.from(cartItems).forEach(cartItem => {
    const product = productMap.get(cartItem.id);
    if (!product) {
      return; // ğŸ›¡ï¸ Guard Clause: ìœ íš¨í•˜ì§€ ì•Šì€ ìƒí’ˆì€ ê±´ë„ˆë›°ê¸°
    }

    // ğŸ¯ DRY ì ìš©: ì¤‘ë³µ ì œê±°ëœ ìœ í‹¸ë¦¬í‹° ì‚¬ìš©
    const quantity = getCartItemQuantity(cartItem);
    const itemTotal = product.val * quantity;

    summaryDetails.innerHTML += `
      <div class="flex justify-between text-xs tracking-wide text-gray-400">
        <span>${product.name} x ${quantity}</span>
        <span>â‚©${itemTotal.toLocaleString()}</span>
      </div>
    `;
  });

  // ğŸ’° ì†Œê³„ í‘œì‹œ (í• ì¸ ì ìš© ì „ ì›ë˜ ê¸ˆì•¡)
  summaryDetails.innerHTML += `
    <div class="border-t border-white/10 my-3"></div>
    <div class="flex justify-between text-sm tracking-wide">
      <span>Subtotal</span>
      <span>â‚©${subTotal.toLocaleString()}</span>
    </div>
  `;

  // ğŸ¯ í• ì¸ ì •ë³´ í‘œì‹œ (ê°œë³„ + ëŒ€ëŸ‰ + í™”ìš”ì¼ í• ì¸)
  if (itemCount >= THRESHOLDS.BULK_DISCOUNT_MIN) {
    summaryDetails.innerHTML += `
        <div class="flex justify-between text-sm tracking-wide text-green-400">
          <span class="text-xs">ğŸ‰ ëŒ€ëŸ‰êµ¬ë§¤ í• ì¸ (${THRESHOLDS.BULK_DISCOUNT_MIN}ê°œ ì´ìƒ)</span>
          <span class="text-xs">-25%</span>
        </div>
      `;
  } else if (itemDiscounts.length > 0) {
    itemDiscounts.forEach(item => {
      summaryDetails.innerHTML += `
        <div class="flex justify-between text-sm tracking-wide text-green-400">
                      <span class="text-xs">${item.name} (${THRESHOLDS.ITEM_DISCOUNT_MIN}ê°œâ†‘)</span>
          <span class="text-xs">-${item.discount}%</span>
        </div>
      `;
    });
  }

  // ğŸŒŸ í™”ìš”ì¼ íŠ¹ê°€ í• ì¸ í‘œì‹œ (10% ì¶”ê°€ í• ì¸)
  if (isTuesdayApplied) {
    summaryDetails.innerHTML += `
          <div class="flex justify-between text-sm tracking-wide text-purple-400">
            <span class="text-xs">ğŸŒŸ í™”ìš”ì¼ ì¶”ê°€ í• ì¸</span>
            <span class="text-xs">-${DISCOUNT_RATES.TUESDAY_DISCOUNT * 100}%</span>
          </div>
        `;
  }

  // ğŸšš ë°°ì†¡ë¹„ í‘œì‹œ (ë¬´ë£Œ ë°°ì†¡ ê¸°ì¤€)
  summaryDetails.innerHTML += `
    <div class="flex justify-between text-sm tracking-wide text-gray-400">
      <span>Shipping</span>
      <span>Free</span>
    </div>
  `;
}

/**
 * ğŸ¤– [AI-REFACTORED] ì´ì•¡ ë° í• ì¸ ì •ë³´ UI ì—…ë°ì´íŠ¸ (SRP ì ìš©)
 *
 * @description ì´ì•¡, í¬ì¸íŠ¸, í• ì¸ ì •ë³´ë¥¼ UIì— í‘œì‹œ
 *
 * ğŸ¯ SRP ì ìš©:
 * - ë‹¨ì¼ ì±…ì„: ì´ì•¡ ê´€ë ¨ UI ì—…ë°ì´íŠ¸ë§Œ ë‹´ë‹¹
 *
 * @param {number} finalAmount - ìµœì¢… ê¸ˆì•¡
 * @param {number} discountRate - í• ì¸ìœ¨
 * @param {number} originalTotal - ì›ë˜ ì´ì•¡
 * @param {boolean} isTuesdayApplied - í™”ìš”ì¼ í• ì¸ ì ìš© ì—¬ë¶€
 */
function updateTotalAndDiscountUI(
  finalAmount,
  discountRate,
  originalTotal,
  isTuesdayApplied,
) {
  // ğŸ’° ì´ì•¡ ì—…ë°ì´íŠ¸ (ìµœì¢… ê²°ì œ ê¸ˆì•¡)
  const totalDiv = uiElements.orderSummary.querySelector('.text-2xl');
  if (totalDiv) {
    totalDiv.textContent = `â‚©${finalAmount.toLocaleString()}`;
  }

  // ğŸ í¬ì¸íŠ¸ í‘œì‹œ ì—…ë°ì´íŠ¸ (ìºì‹œëœ DOM ì‚¬ìš©ìœ¼ë¡œ ì„±ëŠ¥ í–¥ìƒ)
  // ğŸ›¡ï¸ Guard Clause: DOM ìš”ì†Œê°€ ìˆì„ ë•Œë§Œ í¬ì¸íŠ¸ ì—…ë°ì´íŠ¸ (ì›ë˜ ì¤‘ì²© ì œê±°)
  const loyaltyPointsDiv = domElements.loyaltyPoints;
  if (loyaltyPointsDiv) {
    // âš¡ ì„±ëŠ¥ ìµœì í™”: Math í•¨ìˆ˜ ìºì‹±
    const points = Math.floor(finalAmount / THRESHOLDS.POINTS_PER_WON);
    loyaltyPointsDiv.textContent = `ì ë¦½ í¬ì¸íŠ¸: ${points}p`;
    loyaltyPointsDiv.style.display = 'block';
  }

  // ğŸ¯ í• ì¸ ì •ë³´ ì—…ë°ì´íŠ¸ (ìºì‹œëœ DOM ì‚¬ìš©ìœ¼ë¡œ ì„±ëŠ¥ í–¥ìƒ)
  const discountInfoDiv = domElements.discountInfo;
  discountInfoDiv.innerHTML = '';

  // ğŸ§  ë³µì¡í•œ ì¡°ê±´ â†’ ì˜ë¯¸ìˆëŠ” í•¨ìˆ˜ë¡œ ê°œì„ 
  if (shouldShowDiscountInfo(discountRate, finalAmount)) {
    const savedAmount = originalTotal - finalAmount;
    discountInfoDiv.innerHTML = `
      <div class="bg-green-500/20 rounded-lg p-3">
        <div class="flex justify-between items-center mb-1">
          <span class="text-xs uppercase tracking-wide text-green-400">ì´ í• ì¸ìœ¨</span>
          <span class="text-sm font-medium text-green-400">${(discountRate * 100).toFixed(1)}%</span>
        </div>
        <div class="text-2xs text-gray-300">â‚©${Math.round(savedAmount).toLocaleString()} í• ì¸ë˜ì—ˆìŠµë‹ˆë‹¤</div>
      </div>
    `;
  }

  // ğŸŒŸ í™”ìš”ì¼ íŠ¹ê°€ í‘œì‹œ ì—…ë°ì´íŠ¸ (ìºì‹œëœ DOM ì‚¬ìš©ìœ¼ë¡œ ì„±ëŠ¥ í–¥ìƒ)
  const { tuesdaySpecial } = domElements;
  if (isTuesdayApplied) {
    tuesdaySpecial.classList.remove('hidden');
  } else {
    tuesdaySpecial.classList.add('hidden');
  }
}

/**
 * ğŸ¤– [AI-REFACTORED] ì¬ê³  ë¶€ì¡± ì•Œë¦¼ ìƒì„± (SRP ì ìš©)
 *
 * @description ì¬ê³  ë¶€ì¡± ìƒí’ˆë“¤ì˜ ì•Œë¦¼ ë©”ì‹œì§€ë¥¼ ìƒì„±
 *
 * ğŸ¯ SRP ì ìš©:
 * - ë‹¨ì¼ ì±…ì„: ì¬ê³  ì•Œë¦¼ ë©”ì‹œì§€ ìƒì„±ë§Œ ë‹´ë‹¹
 * - ìˆœìˆ˜ í•¨ìˆ˜: DOM ì¡°ì‘ ì—†ìŒ
 *
 * @param {Array} products - ìƒí’ˆ ëª©ë¡
 * @returns {string} ì¬ê³  ì•Œë¦¼ ë©”ì‹œì§€
 */
function generateStockWarningMessage(products) {
  // ğŸ¯ forë¬¸ â†’ filter() + map() + join() ë©”ì„œë“œ ì²´ì¸ìœ¼ë¡œ í˜„ëŒ€í™”
  return products
    .filter(product => product.quantity < THRESHOLDS.LOW_STOCK_WARNING)
    .map(product => {
      if (product.quantity > 0) {
        return `${product.name}: ì¬ê³  ë¶€ì¡± (${product.quantity}ê°œ ë‚¨ìŒ)`;
      } else {
        return `${product.name}: í’ˆì ˆ`;
      }
    })
    .join('\n');
}

/**
 * ì¥ë°”êµ¬ë‹ˆ ì´ ê³„ì‚° ë° UI ì—…ë°ì´íŠ¸ (ë¦¬íŒ©í† ë§ëœ í•¨ìˆ˜)
 *
 * @description ì¥ë°”êµ¬ë‹ˆì˜ ëª¨ë“  ê³„ì‚°ê³¼ UI ì—…ë°ì´íŠ¸ë¥¼ ë‹´ë‹¹í•˜ëŠ” ë³µí•© í•¨ìˆ˜
 *
 * ì£¼ìš” ê¸°ëŠ¥:
 * - ì†Œê³„ ê³„ì‚° (ê° ìƒí’ˆ ê°€ê²© Ã— ìˆ˜ëŸ‰)
 * - ê°œë³„ ìƒí’ˆ í• ì¸ ê³„ì‚° (10ê°œ ì´ìƒì‹œ ìƒí’ˆë³„ í• ì¸ìœ¨ ì ìš©)
 * - ëŒ€ëŸ‰êµ¬ë§¤ í• ì¸ (30ê°œ ì´ìƒì‹œ 25% í• ì¸)
 * - í™”ìš”ì¼ íŠ¹ê°€ ì¶”ê°€ í• ì¸ (10% ì¶”ê°€)
 * - ì ë¦½ í¬ì¸íŠ¸ ê³„ì‚°
 * - ì£¼ë¬¸ ìš”ì•½ UI ì—…ë°ì´íŠ¸
 * - ì¬ê³  ë¶€ì¡± ì•Œë¦¼ ì—…ë°ì´íŠ¸
 *
 * @warning ì´ í•¨ìˆ˜ëŠ” SRP(ë‹¨ì¼ ì±…ì„ ì›ì¹™)ì„ ìœ„ë°˜í•˜ê³  ìˆìŒ
 * - ê³„ì‚° ë¡œì§ê³¼ UI ë¡œì§ì´ ì„ì—¬ ìˆìŒ
 * - 150ì¤„ ì´ìƒì˜ ê±°ëŒ€ í•¨ìˆ˜
 * - í…ŒìŠ¤íŠ¸ ë° ë””ë²„ê¹…ì´ ì–´ë ¤ì›€
 *
 * @sideEffects
 * - ì „ì—­ë³€ìˆ˜ ìˆ˜ì • (totalAmt, itemCnt)
 * - DOM ìš”ì†Œë“¤ ëŒ€ëŸ‰ ìˆ˜ì • (summary-details, cart-total, loyalty-points ë“±)
 * - ë‹¤ë¥¸ í•¨ìˆ˜ í˜¸ì¶œ (updateStockInfoUI, renderBonusPoints)
 */
function handleCalculateCartStuff() {
  // ==========================================
  // ğŸ·ï¸ 1ë‹¨ê³„: ë³€ìˆ˜ ì„ ì–¸ë¶€ (ê´€ì‹¬ì‚¬ë³„ ë¶„ë¥˜)
  // ==========================================

  // ğŸ“Š ë°ì´í„° ê´€ë ¨ ë³€ìˆ˜ë“¤ (ìºì‹œëœ DOM ì‚¬ìš©)
  const cartItems = uiElements.cartDisplay.children;

  // ==========================================
  // ğŸš€ AI ë¦¬íŒ©í† ë§: ìƒˆ í•¨ìˆ˜ ì‚¬ìš©
  // ==========================================

  // ğŸ’° ì†Œê³„ ë° ê°œë³„ í• ì¸ ê³„ì‚° (ì„±ëŠ¥ ê°œì„ ëœ ìˆœìˆ˜ í•¨ìˆ˜ ì‚¬ìš©)
  const { subTotal, itemCount, totalAmount, itemDiscounts } =
    calculateCartSubtotal(cartItems, appState.products);

  // ==========================================
  // ğŸ§® 4ë‹¨ê³„: í• ì¸ ê³„ì‚° ë¡œì§
  // ==========================================

  // ğŸ¯ í• ì¸ ê³„ì‚° (ëŒ€ëŸ‰êµ¬ë§¤, í™”ìš”ì¼ í• ì¸ í¬í•¨)
  const { finalAmount, discountRate, isTuesdayApplied } =
    calculateFinalDiscounts(subTotal, itemCount, totalAmount);

  // ==========================================
  // ğŸ¨ 5ë‹¨ê³„: UI ì—…ë°ì´íŠ¸
  // ==========================================

  // ğŸ“‹ ì£¼ë¬¸ ìš”ì•½ UI ì—…ë°ì´íŠ¸ (ìƒí’ˆë³„ ë‚´ì—­ + í• ì¸ ì •ë³´)
  updateOrderSummaryUI(
    cartItems,
    appState.products,
    subTotal,
    itemDiscounts,
    itemCount,
    isTuesdayApplied,
  );

  // ğŸ’° ì´ì•¡ ë° í• ì¸ ì •ë³´ UI ì—…ë°ì´íŠ¸ (ìµœì¢… ê¸ˆì•¡ + í¬ì¸íŠ¸)
  updateTotalAndDiscountUI(
    finalAmount,
    discountRate,
    subTotal,
    isTuesdayApplied,
  );

  // ğŸ›’ ì¥ë°”êµ¬ë‹ˆ ì•„ì´í…œ ê°œìˆ˜ ì—…ë°ì´íŠ¸ (í—¤ë” ì»´í¬ë„ŒíŠ¸ ì‚¬ìš©)
  updateHeader(itemCount);

  // âš ï¸ ì¬ê³  ë¶€ì¡± ì•Œë¦¼ ë©”ì‹œì§€ ìƒì„± (ì‚¬ìš©ì ì•ˆë‚´)
  const stockMsg = generateStockWarningMessage(appState.products);
  uiElements.stockInfo.textContent = stockMsg;

  // ==========================================
  // ğŸ“ 6ë‹¨ê³„: ìƒíƒœ ì—…ë°ì´íŠ¸ ë° ê´€ë ¨ í•¨ìˆ˜ í˜¸ì¶œ
  // ==========================================

  // ğŸ”„ ê³„ì‚° ì™„ë£Œ í›„ ì „ì—­ ìƒíƒœ ì—…ë°ì´íŠ¸ (ë‹¤ìŒ ê³„ì‚°ì„ ìœ„í•´)
  appState.cart.totalAmount = finalAmount;
  appState.cart.itemCount = itemCount;

  updateStockInfoUI(); // âš ï¸ ì¬ê³  ì •ë³´ ì¶”ê°€ ì—…ë°ì´íŠ¸
  renderBonusPoints(); // ğŸ í¬ì¸íŠ¸ ê³„ì‚° ë° ë Œë”ë§
}

/**
 * ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ ë Œë”ë§ (React íŒ¨í„´ ë„¤ì´ë°)
 *
 * @description êµ¬ë§¤ ê¸ˆì•¡ê³¼ íŠ¹ë³„ ì¡°ê±´ì— ë”°ë¼ ì ë¦½ í¬ì¸íŠ¸ë¥¼ ê³„ì‚°í•˜ê³  UIì— í‘œì‹œ
 *
 * í¬ì¸íŠ¸ ì ë¦½ ê·œì¹™:
 * - ê¸°ë³¸: êµ¬ë§¤ì•¡ì˜ 0.1% (1000ì›ë‹¹ 1í¬ì¸íŠ¸)
 * - í™”ìš”ì¼: ê¸°ë³¸ í¬ì¸íŠ¸ 2ë°°
 * - í‚¤ë³´ë“œ+ë§ˆìš°ìŠ¤ ì„¸íŠ¸: +50í¬ì¸íŠ¸
 * - í’€ì„¸íŠ¸ êµ¬ë§¤ (í‚¤ë³´ë“œ+ë§ˆìš°ìŠ¤+ëª¨ë‹ˆí„°ì•”): +100í¬ì¸íŠ¸ ì¶”ê°€
 * - ëŒ€ëŸ‰êµ¬ë§¤: 10ê°œâ†‘ +20p, 20ê°œâ†‘ +50p, 30ê°œâ†‘ +100p
 *
 * ğŸ¯ ë„¤ì´ë° ê°œì„ : doRenderBonusPoints â†’ renderBonusPoints
 * - React íŒ¨í„´: render + ëŒ€ìƒ
 * - í•¨ìˆ˜ ì„ ì–¸ í†µì¼: const í™”ì‚´í‘œ í•¨ìˆ˜
 *
 * @sideEffects
 * - ì „ì—­ ìƒíƒœ ìˆ˜ì • (appState.cart.bonusPoints)
 * - DOM ìˆ˜ì • (loyalty-points ìš”ì†Œì˜ innerHTML, style.display)
 */
const renderBonusPoints = () => {
  const basePoints = Math.floor(
    appState.cart.totalAmount / THRESHOLDS.POINTS_PER_WON,
  );
  let finalPoints;
  const pointsDetail = [];
  let hasKeyboard;
  let hasMouse;
  let hasMonitorArm;
  const nodes = uiElements.cartDisplay.children;
  if (uiElements.cartDisplay.children.length === 0) {
    domElements.loyaltyPoints.style.display = 'none';
    return;
  }
  finalPoints = 0;
  if (shouldShowPoints(basePoints)) {
    finalPoints = basePoints;
    pointsDetail.push(`ê¸°ë³¸: ${basePoints}p`);
  }

  // ğŸ¯ í™”ìš”ì¼ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ ê³„ì‚°
  const today = new Date();
  const isTuesday = today.getDay() === DAYS.TUESDAY;

  if (shouldApplyTuesdayBonus(isTuesday, appState.cart.totalAmount)) {
    finalPoints *= POINT_BONUSES.TUESDAY_MULTIPLIER;
    pointsDetail.push(`í™”ìš”ì¼ ë³´ë„ˆìŠ¤: ${POINT_BONUSES.TUESDAY_MULTIPLIER}ë°°`);
  }

  // ğŸ¯ ì„¸íŠ¸ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ ê³„ì‚°
  Array.from(nodes).forEach(node => {
    const productId = node.id;
    const quantity = parseInt(
      node.querySelector('.quantity-number').textContent,
    );

    if (productId === PRODUCT_ONE && quantity > 0) {
      hasKeyboard = true;
    }
    if (productId === PRODUCT_TWO && quantity > 0) {
      hasMouse = true;
    }
    if (productId === PRODUCT_THREE && quantity > 0) {
      hasMonitorArm = true;
    }
  });

  if (hasKeyboardMouseSet(hasKeyboard, hasMouse)) {
    finalPoints += POINT_BONUSES.KEYBOARD_MOUSE_SET;
    pointsDetail.push(
      `í‚¤ë³´ë“œ+ë§ˆìš°ìŠ¤ ì„¸íŠ¸: +${POINT_BONUSES.KEYBOARD_MOUSE_SET}p`,
    );
  }

  if (hasFullProductSet(hasKeyboard, hasMouse, hasMonitorArm)) {
    finalPoints += POINT_BONUSES.FULL_SET;
    pointsDetail.push(`í’€ì„¸íŠ¸: +${POINT_BONUSES.FULL_SET}p`);
  }

  // ğŸ¯ ëŒ€ëŸ‰êµ¬ë§¤ ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ ê³„ì‚°
  const totalQuantity = Array.from(nodes).reduce((sum, node) => {
    return sum + parseInt(node.querySelector('.quantity-number').textContent);
  }, 0);

  if (totalQuantity >= THRESHOLDS.BULK_DISCOUNT_MIN) {
    finalPoints += POINT_BONUSES.BULK_30;
    pointsDetail.push(
      `ëŒ€ëŸ‰êµ¬ë§¤ (${THRESHOLDS.BULK_DISCOUNT_MIN}ê°œâ†‘): +${POINT_BONUSES.BULK_30}p`,
    );
  } else if (totalQuantity >= THRESHOLDS.BULK_20_MIN) {
    finalPoints += POINT_BONUSES.BULK_20;
    pointsDetail.push(
      `ëŒ€ëŸ‰êµ¬ë§¤ (${THRESHOLDS.BULK_20_MIN}ê°œâ†‘): +${POINT_BONUSES.BULK_20}p`,
    );
  } else if (totalQuantity >= THRESHOLDS.ITEM_DISCOUNT_MIN) {
    finalPoints += POINT_BONUSES.BULK_10;
    pointsDetail.push(
      `ëŒ€ëŸ‰êµ¬ë§¤ (${THRESHOLDS.ITEM_DISCOUNT_MIN}ê°œâ†‘): +${POINT_BONUSES.BULK_10}p`,
    );
  }

  appState.cart.bonusPoints = finalPoints;
  const ptsTag = domElements.loyaltyPoints;
  if (ptsTag) {
    if (shouldShowPoints(appState.cart.bonusPoints)) {
      ptsTag.innerHTML =
        `<div>ì ë¦½ í¬ì¸íŠ¸: <span class="font-bold">${appState.cart.bonusPoints}p</span></div>` +
        `<div class="text-2xs opacity-70 mt-1">${pointsDetail.join(
          ', ',
        )}</div>`;
      ptsTag.style.display = 'block';
    } else {
      ptsTag.textContent = 'ì ë¦½ í¬ì¸íŠ¸: 0p';
      ptsTag.style.display = 'block';
    }
  }
};

/**
 * ì „ì²´ ì¬ê³  ìˆ˜ëŸ‰ ê³„ì‚° (React íŒ¨í„´ ë„¤ì´ë°)
 *
 * @description ëª¨ë“  ì œí’ˆì˜ ì¬ê³  ìˆ˜ëŸ‰ì„ í•©ì‚°í•˜ì—¬ ë°˜í™˜
 *
 * ğŸ¯ ë„¤ì´ë° ê°œì„ : onGetStockTotal â†’ getTotalStock
 * - React íŒ¨í„´: get + ëŒ€ìƒ
 * - í•¨ìˆ˜ ì„ ì–¸ í†µì¼: const í™”ì‚´í‘œ í•¨ìˆ˜
 * - ì˜ë¯¸ ëª…í™•í™”: ì´ ì¬ê³ ëŸ‰ ì¡°íšŒ
 *
 * @returns {number} ì „ì²´ ì¬ê³  ìˆ˜ëŸ‰ì˜ í•©ê³„
 *
 * @example
 * const totalStock = getTotalStock();
 * console.log(`ì´ ì¬ê³ : ${totalStock}ê°œ`);
 */
const getTotalStock = () => {
  // ğŸ¯ forë¬¸ â†’ reduce() ë©”ì„œë“œë¡œ í˜„ëŒ€í™” (ì˜ë¯¸ì—†ëŠ” ë³€ìˆ˜ëª…ë„ ì œê±°)
  return appState.products.reduce(
    (totalStock, product) => totalStock + product.quantity,
    0,
  );
};

/**
 * ì¬ê³  ì •ë³´ UI ì—…ë°ì´íŠ¸ (React íŒ¨í„´ ë„¤ì´ë°)
 *
 * @description ê° ì œí’ˆì˜ ì¬ê³  ìƒíƒœë¥¼ í™•ì¸í•˜ì—¬ ë¶€ì¡±/í’ˆì ˆ ì•Œë¦¼ ë©”ì‹œì§€ë¥¼ ìƒì„±í•˜ê³  UIì— í‘œì‹œ
 *
 * ì•Œë¦¼ ì¡°ê±´:
 * - ì¬ê³  5ê°œ ë¯¸ë§Œ: "ì¬ê³  ë¶€ì¡± (Nê°œ ë‚¨ìŒ)" ë©”ì‹œì§€ í‘œì‹œ
 * - ì¬ê³  0ê°œ: "í’ˆì ˆ" ë©”ì‹œì§€ í‘œì‹œ
 * - ì „ì²´ ì¬ê³  30ê°œ ë¯¸ë§Œ: ì¶”ê°€ ë¡œì§ ì‹¤í–‰ (í˜„ì¬ ë¹ˆ êµ¬í˜„)
 *
 * ğŸ¯ ë„¤ì´ë° ê°œì„ : handleStockInfoUpdate â†’ updateStockInfoUI
 * - React íŒ¨í„´: update + ëŒ€ìƒ + UI
 * - í•¨ìˆ˜ ì„ ì–¸ í†µì¼: const í™”ì‚´í‘œ í•¨ìˆ˜
 *
 * @sideEffects
 * - stockInfo ìš”ì†Œì˜ textContent ìˆ˜ì •
 */
const updateStockInfoUI = () => {
  let infoMsg = '';
  const totalStock = getTotalStock();
  if (totalStock < THRESHOLDS.STOCK_MANAGEMENT_THRESHOLD) {
    return;
  }
  appState.products.forEach(item => {
    if (item.quantity < THRESHOLDS.LOW_STOCK_WARNING) {
      if (item.quantity > 0) {
        infoMsg = `${infoMsg + item.name}: ì¬ê³  ë¶€ì¡± (${item.quantity}ê°œ ë‚¨ìŒ)\n`;
      } else {
        infoMsg = `${infoMsg + item.name}: í’ˆì ˆ\n`;
      }
    }
  });
  uiElements.stockInfo.textContent = infoMsg;
};

/**
 * ì¥ë°”êµ¬ë‹ˆ ê°€ê²© UI ì—…ë°ì´íŠ¸ (React íŒ¨í„´ ë„¤ì´ë°)
 *
 * @description ë²ˆê°œì„¸ì¼ì´ë‚˜ ì¶”ì²œí• ì¸ì´ ì ìš©ëœ ìƒí’ˆë“¤ì˜ ì¥ë°”êµ¬ë‹ˆ ë‚´ ê°€ê²©ê³¼ ì´ë¦„ì„ ì—…ë°ì´íŠ¸
 *
 * ì—…ë°ì´íŠ¸ ë‚´ìš©:
 * - ìƒí’ˆëª…ì— í• ì¸ ì•„ì´ì½˜ ì¶”ê°€ (âš¡ë²ˆê°œì„¸ì¼, ğŸ’ì¶”ì²œí• ì¸, âš¡ğŸ’ë™ì‹œí• ì¸)
 * - ê°€ê²© í‘œì‹œë¥¼ ì›ê°€ ì·¨ì†Œì„  + í• ì¸ê°€ë¡œ ë³€ê²½
 * - í• ì¸ ìƒíƒœì— ë”°ë¥¸ ìƒ‰ìƒ ë³€ê²½ (ë¹¨ê°•/íŒŒë‘/ë³´ë¼)
 *
 * ğŸ¯ ë„¤ì´ë° ê°œì„ : doUpdatePricesInCart â†’ updateCartPricesUI
 * - React íŒ¨í„´: update + ëŒ€ìƒ + UI
 * - í•¨ìˆ˜ ì„ ì–¸ í†µì¼: const í™”ì‚´í‘œ í•¨ìˆ˜
 *
 * @sideEffects
 * - ì¥ë°”êµ¬ë‹ˆ ì•„ì´í…œë“¤ì˜ ê°€ê²© í‘œì‹œ DOM ìˆ˜ì •
 * - ìƒí’ˆëª… í…ìŠ¤íŠ¸ ìˆ˜ì •
 * - handleCalculateCartStuff() í•¨ìˆ˜ í˜¸ì¶œë¡œ ì „ì²´ ê³„ì‚° ì¬ì‹¤í–‰
 */
const updateCartPricesUI = () => {
  const cartItems = uiElements.cartDisplay.children;
  // ğŸ¯ forë¬¸ â†’ Array.from() + forEach() ë©”ì„œë“œë¡œ í˜„ëŒ€í™”
  Array.from(cartItems).forEach(cartItem => {
    const product = findProductById(cartItem.id);
    if (product) {
      const priceDiv = cartItem.querySelector(DOM_SELECTORS.TEXT_LG);
      const nameDiv = cartItem.querySelector(DOM_SELECTORS.H3);

      // ğŸ¯ DRY ì ìš©: ì¤‘ë³µ ì œê±°ëœ ìœ í‹¸ë¦¬í‹° ì‚¬ìš©
      priceDiv.innerHTML = getDiscountedPriceHTML(product);
      nameDiv.textContent = getDiscountedProductName(product);
    }
  });
  handleCalculateCartStuff();
};

main();
uiElements.addButton.addEventListener('click', () => {
  const selItem = uiElements.productSelect.value;
  // ğŸ¯ DRY ì ìš©: ì¤‘ë³µ ì œê±°ëœ ìœ í‹¸ë¦¬í‹° ì‚¬ìš©
  const itemToAdd = findProductById(selItem);
  // ğŸ›¡ï¸ Guard Clause: ì„ íƒëœ ì•„ì´í…œì´ ì—†ê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ ì¢…ë£Œ
  if (!selItem || !itemToAdd) {
    return;
  }

  // ğŸ›¡ï¸ Guard Clause: ì¬ê³ ê°€ ìˆì„ ë•Œë§Œ ì¥ë°”êµ¬ë‹ˆ ì¶”ê°€ ë¡œì§ ì‹¤í–‰
  if (!isProductOutOfStock(itemToAdd)) {
    // ğŸ¨ ì½”ë”© ìŠ¤íƒ€ì¼ í†µì¼: ëŒ€ê´„í˜¸ â†’ ì  í‘œê¸°ë²•
    const item = document.getElementById(itemToAdd.id);
    if (item) {
      // ğŸ¯ DRY ì ìš©: ì¤‘ë³µ ì œê±°ëœ ìœ í‹¸ë¦¬í‹° ì‚¬ìš©
      const currentQty = getCartItemQuantity(item);
      const newQty = currentQty + 1;
      if (canIncreaseQuantity(newQty, itemToAdd, currentQty)) {
        const qtyElem = item.querySelector('.quantity-number');
        qtyElem.textContent = newQty;
        itemToAdd.quantity--;
      } else {
        alert('ì¬ê³ ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.');
      }
    } else {
      const newItem = document.createElement('div');
      newItem.id = itemToAdd.id;
      newItem.className =
        'grid grid-cols-[80px_1fr_auto] gap-5 py-5 border-b border-gray-100 first:pt-0 last:border-b-0 last:pb-0';
      newItem.innerHTML = `
        <div class="w-20 h-20 bg-gradient-black relative overflow-hidden">
          <div class="absolute top-1/2 left-1/2 w-[60%] h-[60%] bg-white/10 -translate-x-1/2 -translate-y-1/2 rotate-45"></div>
        </div>
        <div>
          <h3 class="text-base font-normal mb-1 tracking-tight">${getDiscountedProductName(itemToAdd)}</h3>
          <p class="text-xs text-gray-500 mb-0.5 tracking-wide">PRODUCT</p>
          <p class="text-xs text-black mb-3">${getDiscountedPriceHTML(itemToAdd)}</p>
          <div class="flex items-center gap-4">
            <button class="quantity-change w-6 h-6 border border-black bg-white text-sm flex items-center justify-center transition-all hover:bg-black hover:text-white" data-product-id="${itemToAdd.id}" data-change="-1">âˆ’</button>
            <span class="quantity-number text-sm font-normal min-w-[20px] text-center tabular-nums">1</span>
            <button class="quantity-change w-6 h-6 border border-black bg-white text-sm flex items-center justify-center transition-all hover:bg-black hover:text-white" data-product-id="${itemToAdd.id}" data-change="1">+</button>
          </div>
        </div>
        <div class="text-right">
          <div class="text-lg mb-2 tracking-tight tabular-nums">${getDiscountedPriceHTML(itemToAdd)}</div>
          <a class="remove-item text-2xs text-gray-500 uppercase tracking-wider cursor-pointer transition-colors border-b border-transparent hover:text-black hover:border-black" data-product-id="${itemToAdd.id}">Remove</a>
        </div>
      `;
      uiElements.cartDisplay.appendChild(newItem);
      itemToAdd.quantity--;
    }
    handleCalculateCartStuff();
    appState.lastSelected = selItem;
  }
});
uiElements.cartDisplay.addEventListener('click', event => {
  const tgt = event.target;
  if (
    tgt.classList.contains(DOM_SELECTORS.QUANTITY_CHANGE.slice(1)) ||
    tgt.classList.contains(DOM_SELECTORS.REMOVE_ITEM.slice(1))
  ) {
    const prodId = tgt.dataset.productId;
    const itemElem = document.getElementById(prodId);
    // ğŸ¯ DRY ì ìš©: ì¤‘ë³µ ì œê±°ëœ ìœ í‹¸ë¦¬í‹° ì‚¬ìš©
    const prod = findProductById(prodId);
    if (tgt.classList.contains(DOM_SELECTORS.QUANTITY_CHANGE.slice(1))) {
      const qtyChange = parseInt(tgt.dataset.change);
      // ğŸ¯ DRY ì ìš©: ì¤‘ë³µ ì œê±°ëœ ìœ í‹¸ë¦¬í‹° ì‚¬ìš©
      const currentQty = getCartItemQuantity(itemElem);
      const newQty = currentQty + qtyChange;
      // ğŸ§  ë³µì¡í•œ ì¡°ê±´ â†’ ì˜ë¯¸ìˆëŠ” í•¨ìˆ˜ë¡œ ê°œì„ 
      if (isValidQuantityChange(newQty, prod, currentQty)) {
        const qtyElem = itemElem.querySelector('.quantity-number');
        qtyElem.textContent = newQty;
        prod.quantity -= qtyChange;
      } else if (shouldRemoveFromCart(newQty)) {
        prod.quantity += currentQty;
        itemElem.remove();
      } else {
        alert('ì¬ê³ ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.');
      }
    } else if (tgt.classList.contains(DOM_SELECTORS.REMOVE_ITEM.slice(1))) {
      // ğŸ¯ DRY ì ìš©: ì¤‘ë³µ ì œê±°ëœ ìœ í‹¸ë¦¬í‹° ì‚¬ìš©
      const remQty = getCartItemQuantity(itemElem);
      prod.quantity += remQty;
      itemElem.remove();
    }
    // ğŸ” ì¬ê³  ìƒíƒœ í™•ì¸ (í•„ìš”ì‹œ ì¶”ê°€ ë¡œì§ êµ¬í˜„ ê°€ëŠ¥)
    handleCalculateCartStuff();
    updateProductSelectUI();
  }
});
