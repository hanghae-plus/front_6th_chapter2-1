# 장바구니 시스템 리팩토링 계획서

## 📋 개요

### 현재 상태

- **파일**: `src/basic/main.basic.js` (763줄)
- **주요 문제**: 과도하게 긴 함수, 전역 상태, 중복 코드, 매직 넘버
- **테스트**: `src/basic/__tests__/basic.test.js` (모든 테스트 통과 필수)

### 목표

- 코드 동작 유지 (기능 변경 금지)
- 구조 변경을 통한 가독성 및 유지보수성 향상
- Clean Code 원칙 적용
- 모든 테스트 통과 보장

---

## 🎯 리팩토링 우선순위

### 1단계 (Critical) - 안정성 확보

테스트 안정성을 보장하면서 기본적인 구조 정리

### 2단계 (High) - 가독성 개선

함수 분리와 네이밍을 통한 코드 이해도 향상

### 3단계 (Medium) - 중복 제거

반복되는 패턴과 코드 블록 추상화

### 4단계 (Low) - 최적화

성능 개선 및 추가적인 구조 정리

---

## 📝 상세 태스크 목록

### 🚨 1단계: 안정성 확보 (Critical)

#### 1.1 테스트 환경 검증

- **Priority**: P0
- **Size**: Small
- **Tasks**:
  - [ ] 현재 테스트 실행하여 기준선 확보
  - [ ] 테스트 중 스킵된 항목 파악
  - [ ] 리팩토링 전 스냅샷 생성

#### 1.2 전역 변수 정리

- **Priority**: P0
- **Size**: Medium
- **Problems**:
  ```javascript
  var prodList,
    bonusPts = 0,
    stockInfo,
    itemCnt,
    lastSel,
    sel,
    addBtn,
    totalAmt = 0;
  ```
- **Tasks**:
  - [x] 전역 변수 목록 정리 (prodList, bonusPts, stockInfo 등)
  - [x] const/let으로 변경 가능한 변수 식별
  - [x] 변수 스코프 최소화 계획 수립

#### 1.3 매직 넘버 상수화

- **Priority**: P0
- **Size**: Small
- **Problems**: `10`, `30`, `0.1`, `5` 등 의미 불명확한 숫자들
- **Tasks**:
  - [x] 할인 임계값 상수화 (`BULK_DISCOUNT_THRESHOLD = 10`)
  - [x] 할인율 상수화 (`TUESDAY_DISCOUNT_RATE = 0.1`)
  - [x] 재고 부족 기준 상수화 (`LOW_STOCK_THRESHOLD = 5`)
  - [x] 포인트 적립 기준 상수화 (`POINTS_PER_1000 = 1`)

### 🔧 2단계: 가독성 개선 (High)

#### 2.1 거대한 함수 분해 - calcCart

- **Priority**: P1
- **Size**: Large
- **Problems**: 209줄의 `calcCart` 함수가 모든 책임을 가짐
- **Tasks**:
  - [ ] 장바구니 아이템 계산 분리 (`calculateCartItems`)
  - [ ] 할인 계산 분리 (`calculateDiscounts`)
  - [ ] 포인트 계산 분리 (`calculatePoints`)
  - [ ] UI 업데이트 분리 (`updateUI`)
  - [ ] 재고 상태 업데이트 분리 (`updateStockStatus`)

#### 2.2 함수명 및 변수명 개선

- **Priority**: P1
- **Size**: Medium
- **Problems**: `p`, `q`, `amt`, `sel`, `tgt` 등 의미 불분명한 이름들
- **Tasks**:
  - [ ] 상품 변수명 정규화 (`p1` → `PRODUCT_KEYBOARD`)
  - [ ] 수량 변수명 명확화 (`q` → `quantity`)
  - [ ] 금액 변수명 명확화 (`amt` → `amount`)
  - [ ] 선택자 변수명 명확화 (`sel` → `productSelect`)

#### 2.3 조건문 가독성 개선

- **Priority**: P1
- **Size**: Medium
- **Problems**: 복잡한 중첩 조건문과 긴 조건식
- **Tasks**:
  - [ ] 화요일 체크 함수화 (`isTuesday()`)
  - [ ] 할인 조건 함수화 (`isEligibleForBulkDiscount()`)
  - [ ] 재고 상태 체크 함수화 (`isLowStock()`, `isOutOfStock()`)
  - [ ] 조기 반환 패턴 적용

### 🔄 3단계: 중복 제거 (Medium)

#### 3.1 포인트 계산 로직 통합

- **Priority**: P2
- **Size**: Medium
- **Problems**: `calcCart`와 `doRenderBonusPoints`에서 중복 계산
- **Tasks**:
  - [ ] 기본 포인트 계산 함수 생성 (`calculateBasePoints`)
  - [ ] 화요일 포인트 배수 함수 생성 (`applyTuesdayPointsMultiplier`)
  - [ ] 세트 구매 보너스 함수 생성 (`calculateSetBonus`)
  - [ ] 수량별 보너스 함수 생성 (`calculateQuantityBonus`)

#### 3.2 재고 체크 로직 통합

- **Priority**: P2
- **Size**: Small
- **Problems**: 여러 곳에서 재고 계산 중복
- **Tasks**:
  - [ ] 총 재고 계산 함수 정리 (`getTotalStock`)
  - [ ] 재고 부족 상품 목록 함수 생성 (`getLowStockItems`)
  - [ ] 재고 상태 메시지 생성 함수 생성 (`generateStockMessage`)

#### 3.3 DOM 조작 패턴 추상화

- **Priority**: P2
- **Size**: Medium
- **Problems**: 반복되는 DOM 조작 코드
- **Tasks**:
  - [ ] 요소 텍스트 업데이트 헬퍼 (`updateElementText`)
  - [ ] 장바구니 아이템 생성 템플릿화 (`createCartItemElement`)
  - [ ] 할인 표시 로직 통합 (`updateDiscountDisplay`)

### ⚡ 4단계: 최적화 (Low)

#### 4.1 성능 최적화

- **Priority**: P3
- **Size**: Small
- **Problems**: 불필요한 재계산과 DOM 조작
- **Tasks**:
  - [ ] Date 객체 생성 최소화
  - [ ] innerHTML 대신 textContent 사용 최적화
  - [ ] 이벤트 리스너 최적화

#### 4.2 코드 조직화

- **Priority**: P3
- **Size**: Medium
- **Tasks**:
  - [ ] 상수 영역 정리
  - [ ] 함수 선언 순서 정리 (호출 순서대로)
  - [ ] 관련 함수들 그룹화
  - [ ] 주석 정리 및 JSDoc 적용

---

## 🧪 각 단계별 검증 기준

### 1단계 완료 기준

- [ ] 모든 테스트 통과
- [ ] 전역 변수 const/let으로 전환
- [ ] 매직 넘버 상수화 완료
- [ ] 코드 동작 100% 일치

### 2단계 완료 기준

- [ ] `calcCart` 함수 200줄 → 50줄 이하
- [ ] 함수별 단일 책임 원칙 적용
- [ ] 의미 있는 함수/변수명 적용
- [ ] 모든 테스트 통과

### 3단계 완료 기준

- [ ] 중복 코드 90% 이상 제거
- [ ] 포인트/재고 계산 로직 통합
- [ ] DOM 조작 헬퍼 함수 적용
- [ ] 모든 테스트 통과

### 4단계 완료 기준

- [ ] 불필요한 재계산 제거
- [ ] 코드 구조 최종 정리
- [ ] JSDoc 문서화 완료
- [ ] 모든 테스트 통과

---

## 🔧 리팩토링 실행 가이드

### 안전한 리팩토링을 위한 규칙

1. **테스트 우선**: 모든 변경 후 즉시 테스트 실행
2. **작은 단위**: 한 번에 하나의 변경만 수행
3. **기능 보존**: 동작 변경 절대 금지
4. **점진적 개선**: 단계별 검증 후 다음 단계 진행

### 각 태스크 실행 순서

```bash
# 1. 현재 상태 검증
npm test

# 2. 하나의 태스크 수행
# 예: 매직 넘버 상수화

# 3. 즉시 테스트 검증
npm test

# 4. 통과하면 다음 태스크, 실패하면 롤백
```

### 리팩토링 체크리스트

#### 각 변경 후 확인사항

- [ ] `npm test` 실행하여 모든 테스트 통과
- [ ] 브라우저에서 기능 동작 확인
- [ ] 콘솔 에러 없음 확인
- [ ] 메모리 누수 없음 확인

#### 완료 후 최종 검증

- [ ] 전체 테스트 통과 (스킵된 테스트 제외)
- [ ] 기능 시나리오 수동 테스트
- [ ] 코드 리뷰 준비 (변경점 정리)
- [ ] 성능 비교 (변경 전/후)

---

## 📊 예상 결과

### 리팩토링 전

- **파일 수**: 1개 (main.basic.js)
- **총 라인 수**: 763줄
- **최대 함수 길이**: 209줄 (`calcCart`)
- **전역 변수**: 12개
- **매직 넘버**: 15개 이상

### 리팩토링 후 (목표)

- **파일 수**: 1개 (구조만 정리, 파일 분리는 하지 않음)
- **총 라인 수**: 700줄 이하 (주석 포함)
- **최대 함수 길이**: 20줄 이하
- **전역 변수**: 5개 이하
- **매직 넘버**: 0개

### 품질 개선 지표

- **가독성**: 함수명으로 의도 파악 가능
- **유지보수성**: 단일 책임 함수로 변경 영향 최소화
- **테스트 안정성**: 100% 테스트 통과 유지
- **성능**: 기존 성능 유지 또는 개선

---

## 🚨 주의사항

### 절대 금지 사항

- ❌ 기능 동작 변경
- ❌ 테스트 코드 수정
- ❌ 새로운 파일 생성 (단일 파일 유지)
- ❌ 외부 라이브러리 추가

### 필수 준수 사항

- ✅ 모든 테스트 통과 유지
- ✅ `main.basic.js` 파일 기준으로 작업
- ✅ 단계별 검증 수행
- ✅ Clean Code 원칙 적용

---

## 📅 예상 일정

| 단계     | 소요 시간     | 완료 기준           |
| -------- | ------------- | ------------------- |
| 1단계    | 2-3시간       | 안정성 확보         |
| 2단계    | 4-5시간       | 가독성 개선         |
| 3단계    | 3-4시간       | 중복 제거           |
| 4단계    | 2-3시간       | 최적화              |
| **총계** | **11-15시간** | **완전한 리팩토링** |

이 계획서를 기반으로 체계적이고 안전한 리팩토링을 수행하여 깨끗하고 유지보수 가능한 코드로 개선할 수 있습니다.
